name: Windows Docker Image CI

on: [push, pull_request]

jobs:
  build:

    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-2019, windows-2016]

    steps:
    - uses: actions/checkout@v1
    - name: Build Images
      run: |
        $tags = @('3.6.2', '3.6', '3')
        Get-ChildItem -Path windows\* -File -Include "Dockerfile.windows-*" | ForEach-Object {
          Push-Location
          $dockerfile = $_

          $windowsType = 'windows-servercore'
          $windowsDockerTag = ('ltsc{0}' -f '${{ matrix.os }}'.Replace('windows-', ''))

          if($dockerfile.Name.Contains('nanoserver')) {
            # No nanoserver for 2016
            if('${{ matrix.os }}' -eq 'windows-2016') {
              continue
            }
            $windowsType = 'windows-nanoserver'
            $windowsDockerTag = '1809'
          }

          # run tests
          Push-Location
          $env:TAG=$dockerfile.Name.Replace('Dockerfile.windows-', '')
          $env:WINDOWS_DOCKER_TAG=$windowsDockerTag
          Invoke-Pester -Path tests
          Remove-Item env:\TAG
          Remove-Item env:\WINDOWS_DOCKER_TAG
          Pop-Location

          $tags | ForEach-Object {
            $tag = ('maven:{0}-{1}-{2}-{3}' -f $_,$dockerfile.Name.Replace('Dockerfile.windows-', ''),$windowsType,$windowsDockerTag)
            docker build -f $dockerfile --tag $tag --build-arg WINDOWS_DOCKER_TAG=${windowsDockerTag} .

            if('${{ github.event_name }}' -eq 'push') {
              Write-Host 'YOU ARE IN A PUSH OPERATION'
            #  '${{ secrets.DOCKER_PASSWORD }}' | docker login --username ${{ secrets.DOCKER_USERNAME }} --password-stdin
            #  & docker push $tag
            }
          }
          Pop-Location
        }
      shell: pwsh